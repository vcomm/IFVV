const statusEl=document.getElementById("status");let dataSender=e=>{console.warn("Sender не инициализирован")};const controlState={move:{x:0,y:0},zoom:{x:0,y:0}},getConfig=(()=>{const e=JSON.parse(atob("eyJhdXRoRG9tYWluIjoiZmlyLWZ2di5maXJlYmFzZWFwcC5jb20iLCJkYXRhYmFzZVVSTCI6Imh0dHBzOi8vZmlyLWZ2di1kZWZhdWx0LXJ0ZGIuZmlyZWJhc2Vpby5jb20iLCJwcm9qZWN0SWQiOiJmaXItZnZ2Iiwic3RvcmFnZUJ1Y2tldCI6ImZpci1mdnYuZmlyZWJhc2VzdG9yYWdlLmFwcCIsIm1lc3NhZ2luZ1NlbmRlcklkIjoiNjI0MDU0ODQ1MjMiLCJhcHBJZCI6IjE6NjI0MDU0ODQ1MjM6d2ViOjhmMGEwNjEyOGQzMmQ5MGYyNTAzYWUiLCJtZWFzdXJlbWVudElkIjoiRy0wUzc3OVc2NjMxIn0="));return t=>({apiKey:t,...e})})();function setupJoystick(e,t,n){const o=document.getElementById(e),s=document.getElementById(t);let a=!1;const i=o.offsetWidth/2;function c(e){if(!a)return;e.preventDefault();const t=o.getBoundingClientRect(),s=e.touches?e.touches[0]:e;let c=s.clientX-t.left-i,r=s.clientY-t.top-i;n(c,r,i,!1)}function r(){a&&(a=!1,s.style.transition="transform 0.2s",s.style.transform="translate(0px, 0px)",n(0,0,i,!0),setTimeout(()=>s.style.transition="",200))}o.addEventListener("mousedown",e=>{a=!0,c(e)}),window.addEventListener("mousemove",e=>c(e)),window.addEventListener("mouseup",r),o.addEventListener("touchstart",e=>{a=!0,c(e)}),window.addEventListener("touchmove",e=>c(e)),window.addEventListener("touchend",r)}function startSending(){setInterval(()=>{if(0!==controlState.move.x||0!==controlState.move.y||0!==controlState.zoom.x||0!==controlState.zoom.y){const e={type:"control",state:controlState};dataSender(JSON.stringify(e))}},50)}function connectWebSocket(e,t){const n=new WebSocket(e);n.onopen=()=>{n.send(JSON.stringify({type:"join_pair",pairID:t})),statusEl.textContent="Connected (WS)",dataSender=e=>n.send(e),startSending()},n.onclose=()=>{statusEl.textContent="Disconnected"},n.onerror=()=>{statusEl.textContent="Error WS"}}async function connectFirebase(e,t){try{firebase.initializeApp(e);const n=firebase.database().ref("pairs/"+t),o=new RTCPeerConnection({iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]});o.onicecandidate=e=>{e.candidate&&n.child("answerCandidates").push(e.candidate.toJSON())},o.ondatachannel=e=>{const t=e.channel;t.onopen=()=>{statusEl.textContent="Connected (WebRTC)",dataSender=e=>t.send(e),startSending()},t.onmessage=e=>{console.log("Received message:",e.data)}};const s=(await n.child("offer").once("value")).val();if(!s)throw new Error("Offer not find in Firebase");await o.setRemoteDescription(new RTCSessionDescription(s));const a=await o.createAnswer();await o.setLocalDescription(a),await n.child("answer").set({sdp:a.sdp,type:a.type}),n.child("offerCandidates").on("child_added",e=>{const t=new RTCIceCandidate(e.val());o.addIceCandidate(t)})}catch(e){statusEl.textContent="Error WebRTC",console.error(e)}}setupJoystick("move-joystick","move-handle",(e,t,n,o)=>{const s=Math.sqrt(e*e+t*t);s>n&&(e=e/s*n,t=t/s*n),document.getElementById("move-handle").style.transform=`translate(${e}px, ${t}px)`,controlState.move=o?{x:0,y:0}:{x:e/n,y:t/n}}),setupJoystick("zoom-joystick","zoom-handle",(e,t,n,o)=>{document.getElementById("zoom-handle").style.transform=`translate(${e}px, ${t}px)`,controlState.zoom=o?{x:0,y:0}:{x:e/n,y:-t/n}}),window.addEventListener("load",()=>{const e=new URLSearchParams(window.location.search),t=e.get("provider"),n=e.get("pairID");if(t&&n)if("firebase"===t){const t=e.get("apiKey");if(!t)return void(statusEl.textContent="Error: apiKey is required for Firebase");connectFirebase(getConfig(t),n)}else{connectWebSocket(decodeURIComponent(e.get("wsUrl")),n)}else statusEl.textContent="Error: Invalid URL parameters"});