const template=document.createElement("template");template.innerHTML='\n  <style>\n    :host { display: inline-block; width: var(--fvv-width, 800px); height: var(--fvv-height, 450px); background-color: #000; position: relative; border-radius: 8px; overflow: hidden; font-family: sans-serif; color: white; }\n    :host(:fullscreen) { border-radius: 0; width: 100vw; height: 100vh; }\n    canvas { width: 100%; height: 100%; transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); }\n    canvas.is-switching { transition-duration: 0.1s; transform: scale(1.2) !important; }\n    #video-container, .dummy-source-canvas { display: none; }\n    #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }\n    .display-info { position: absolute; top: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; font-size: 12px; font-family: monospace; }\n    #mode-display { left: 10px; position: relative;}\n    #camera-info-display { left: 10px; text-align: left; position: relative;}\n    #control-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); display: flex; align-items: center; padding: 0 10px; pointer-events: auto; justify-content: space-between; }\n    .controls-left, .controls-right, .controls-center { display: flex; align-items: center; gap: 10px; }\n    #play-pause-btn, .script-btn, #audio-onoff-btn, #fullscreen-btn, #remote-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }\n    #remote-btn { font-size: 16px; margin-top: -5px;}\n    #remote-btn:disabled, .script-btn:disabled, #play-pause-btn:disabled { opacity: 0.5; cursor: not-allowed; }\n    #record-btn { font-size: 36px; }\n    #record-btn.is-recording { color: #ff4136; animation: pulse 1.5s infinite; }\n    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }\n    #timeline { width: 100%; cursor: pointer; flex-grow: 1; }\n    #radar-plugin-container { position: absolute; bottom: 0; right: 0; }\n    #qr-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; pointer-events: auto; }\n    #qrcode { padding: 20px; background: white; margin-bottom: 20px; }\n    #ws-address { word-break: break-all; max-width: 90%; }\n  </style>\n  <canvas></canvas>\n  <div id="video-container"></div>\n  <div id="dummy-canvas-container"></div>\n  <div id="ui-container">\n    <div id="mode-display">MODE: MAIN</div>\n    <div id="camera-info-display"></div>\n    <div id="radar-plugin-container"></div>\n    <div id="control-bar"> <div class="controls-left"> <button id="play-pause-btn">‚ñ∂Ô∏è</button> <input type="range" id="timeline" min="0" max="100" value="0" step="0.1"> <button id="audio-onoff-btn">üîá</button></div> <div class="controls-center"> <button id="record-btn" class="script-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π">‚óè</button> <button id="play-script-btn" class="script-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π" disabled>‚ñ∫</button> <button id="save-script-btn" class="script-btn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π" disabled>‚¨áÔ∏è</button> <button id="load-script-btn" class="script-btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π">‚¨ÜÔ∏è</button> </div> <div class="controls-right"> <button id="fullscreen-btn" title="Full Screen">‚õ∂</button> <button id="remote-btn">[QR-üéÆ]</button> </div> </div>\n    <div id="qr-modal"> <h2>Scan the code with your phone</h2> <div id="qrcode"></div> <p>Link for the remote:</p> <code id="ws-address"></code> <p>(Click on the dark background to close)</p> </div>\n  </div>\n';class BasePairingProvider{constructor(t){if(this.constructor===BasePairingProvider)throw new Error("Abstract classes can't be instantiated.");this.player=t,this.ui=t.ui}initialize(){throw new Error("Method 'initialize()' must be implemented.")}generateQR(t,e){this.ui.wsAddressEl.textContent=`Scan the code. Pair ID: ${e}`,this.ui.qrCodeEl.innerHTML="",new QRCode(this.ui.qrCodeEl,{text:t,width:128,height:128})}}class WebSocketPairingProvider extends BasePairingProvider{initialize(){const t=document.createElement("script");t.src="./src/qrcode.min.js",t.onload=()=>{this.player.ui.remoteBtn.disabled=!1,this.connect()},this.player.shadowRoot.appendChild(t)}connect(){const t=this.player.getAttribute("pairing-service-url");if(!t)return void console.error("Attribute 'pairing-service-url' is not set!");const e=()=>{const i=new WebSocket(t);i.onopen=()=>{i.send(JSON.stringify({type:"create_pair"}))},i.onmessage=e=>{const i=JSON.parse(e.data);if("pair_created"===i.type){const e=`${this.player.getAttribute("remote-url")||window.location.origin}/remote.html?provider=websocket&wsUrl=${encodeURIComponent(t)}&pairID=${i.pairID}`;this.generateQR(e,i.pairID)}else"control"===i.type&&this.player.handleRemoteControl(i)},i.onclose=()=>{setTimeout(e,2e3)},i.onerror=()=>i.close()};e()}}const getFirebaseConfig=()=>({apiKey:"AIzaSyAkjhhQOGrJ9amLBoHNshTmTLHLunSuVy4",authDomain:"fir-fvv.firebaseapp.com",databaseURL:"https://fir-fvv-default-rtdb.firebaseio.com",projectId:"fir-fvv",storageBucket:"fir-fvv.firebasestorage.app",messagingSenderId:"62405484523",appId:"1:62405484523:web:8f0a06128d32d90f2503ae",measurementId:"G-0S779W6631"});class FirebasePairingProvider extends BasePairingProvider{constructor(t){super(t),this.peerConnection=null,this.db=null,this.pairRef=null}initialize(){const t=["https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js","https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js",new URL("./qrcode.min.js",import.meta.url).href];this.loadScripts(t,()=>{this.player.ui.remoteBtn.disabled=!1,this.connect()})}loadScripts(t,e){let i=0;t.forEach(s=>{const a=document.createElement("script");a.src=s,a.onload=()=>{i++,i===t.length&&e()},this.player.shadowRoot.appendChild(a)})}async connect(){try{firebase.initializeApp(getFirebaseConfig());this.db=firebase.database();const t=Math.random().toString(36).substring(2,8).toUpperCase();this.pairRef=this.db.ref("pairs/"+t);const e={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]};this.peerConnection=new RTCPeerConnection(e);const i=this.peerConnection.createDataChannel("controls");i.onopen=()=>console.log("Firebase/WebRTC: DataChannel opened!"),i.onmessage=t=>this.player.handleRemoteControl(JSON.parse(t.data));const s=this.pairRef.child("offerCandidates");this.peerConnection.onicecandidate=t=>{t.candidate&&s.push(t.candidate.toJSON())};const a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a),await this.pairRef.set({offer:{sdp:a.sdp,type:a.type}});const r=`${this.player.getAttribute("remote-url")||window.location.origin}/remote.html?provider=firebase&apiKey=${encodeURIComponent(getFirebaseConfig().apiKey)}&pairID=${t}`;console.log("Firebase/WebRTC: remoteURL, ID:",r),this.generateQR(r,t);const n=this.pairRef.child("answerCandidates");this.pairRef.child("answer").on("value",t=>{const e=t.val();e&&!this.peerConnection.currentRemoteDescription&&this.peerConnection.setRemoteDescription(new RTCSessionDescription(e))}),n.on("child_added",t=>{const e=new RTCIceCandidate(t.val());this.peerConnection.addIceCandidate(e)}),window.addEventListener("beforeunload",()=>this.pairRef.remove())}catch(t){console.error("Initialization error Firebase/WebRTC:",t)}}}class FvvRadarSpherePlugin{constructor(t,e){this.player=t,this.container=e,this.cameraMap=null,this.sphereRotation={x:-20,y:0},this.isDragging=!1,this.lastMousePos={x:0,y:0},this.initUI(),this.initSphereGrid(),this.addEventListeners(),this.player.addEventListener("statechange",t=>this.onPlayerStateChange(t.detail)),this.player.addEventListener("cameramaploaded",t=>this.onCameraMapLoaded(t.detail)),this.player.addEventListener("activecamerachange",t=>this.onActiveCameraChange(t.detail))}initUI(){this.container.innerHTML='\n            <style>\n                .radar-wrapper-container { position: absolute; bottom: 60px; right: 10px; display: flex; flex-direction: column; align-items: center; pointer-events: auto; }\n                .radar-wrapper { position: relative; width: 150px; height: 150px; perspective: 600px; cursor: grab; }\n                .radar-wrapper.is-scripting { pointer-events: none; opacity: 0.7; }\n                .radar-wrapper:active { cursor: grabbing; }\n                .sphere-container { width: 100%; height: 100%; }\n                .sphere-bg { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #555, #222); }\n                .grid-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; }\n                .radar-point { position: absolute; top: 0; left: 0; width: 10px; height: 10px; background: var(--fvv-radar-point-color, #00aaff); border-radius: 50%; border: 1px solid white; margin: -5px 0 0 -5px; transition: background-color 0.2s; }\n                .radar-point.is-active { background-color: var(--fvv-radar-point-active-color, #ffcc00); box-shadow: 0 0 8px var(--fvv-radar-point-active-color, #ffcc00); }\n                .crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 1px solid var(--fvv-radar-crosshair-color, lime); border-radius: 50%; margin: -11px 0 0 -11px; background: radial-gradient(circle, transparent 4px, var(--fvv-radar-crosshair-color, lime) 5px); transition: transform 0.1s; pointer-events: none; }\n                .coords-display { margin-top: 5px; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 10px; text-align: center; }\n            </style>\n            <div class="radar-wrapper-container">\n                <div id="radar-wrapper" class="radar-wrapper">\n                    <div class="sphere-container">\n                        <div class="sphere-bg"></div>\n                    </div>\n                    <svg class="grid-svg"></svg>\n                    <div id="radar-crosshair" class="crosshair"></div>\n                </div>\n                <div id="coords-display" class="coords-display"></div>\n            </div>\n    ',this.ui={wrapper:this.container.querySelector("#radar-wrapper"),sphereContainer:this.container.querySelector(".sphere-container"),svg:this.container.querySelector(".grid-svg"),crosshair:this.container.querySelector("#radar-crosshair"),coordsDisplay:this.container.querySelector("#coords-display")}}initSphereGrid(){this.R=75,this.svgGrid={lines:[]};const t=Array.from({length:12},(t,e)=>30*e),e=()=>{const t=document.createElementNS("http://www.w3.org/2000/svg","line");return t.setAttribute("stroke","rgba(255, 255, 255, 0.2)"),t.setAttribute("stroke-width","0.5"),t},i=[30,60,90,120,150].map(t=>{const e=t*Math.PI/180,i=this.R*Math.sin(e),s=this.R*Math.cos(e),a=[];for(let t=0;t<=360;t+=10){const e=t*Math.PI/180;a.push({x:i*Math.cos(e),y:i*Math.sin(e),z:s})}return a}),s=t.map(t=>{const e=t*Math.PI/180,i=[];for(let t=0;t<=180;t+=10){const s=t*Math.PI/180;i.push({x:this.R*Math.sin(s)*Math.cos(e),y:this.R*Math.sin(s)*Math.sin(e),z:this.R*Math.cos(s)})}return i});i.forEach(t=>{for(let i=0;i<t.length-1;i++){const s=e();this.ui.svg.appendChild(s),this.svgGrid.lines.push({line:s,p1:t[i],p2:t[i+1]})}}),s.forEach(t=>{for(let i=0;i<t.length-1;i++){const s=e();this.ui.svg.appendChild(s),this.svgGrid.lines.push({line:s,p1:t[i],p2:t[i+1]})}})}addEventListeners(){this.ui.wrapper.addEventListener("mousedown",t=>{this.player.isPlayingScript||(this.isDragging=!0,this.lastMousePos={x:t.clientX,y:t.clientY})}),window.addEventListener("mousemove",t=>{if(!this.isDragging||this.player.isPlayingScript)return;const e=t.clientX-this.lastMousePos.x,i=t.clientY-this.lastMousePos.y;if(this.lastMousePos={x:t.clientX,y:t.clientY},t.shiftKey){const t=this.player.viewpoint.height-.01*i;this.player.setViewpoint({...this.player.viewpoint,height:Math.max(-1,Math.min(1,t))})}else{const t={x:this.player.sphereRotation.x-.5*i,y:this.player.sphereRotation.y+.5*e};t.x=Math.max(-90,Math.min(90,t.x)),this.player.setSphereRotation(t)}}),window.addEventListener("mouseup",()=>{this.isDragging=!1}),window.addEventListener("mouseleave",()=>{this.isDragging=!1}),this.ui.wrapper.addEventListener("wheel",t=>{if(this.player.isPlayingScript)return;t.preventDefault();const e=this.player.viewpoint.zoom-.05*Math.sign(t.deltaY);this.player.setViewpoint({...this.player.viewpoint,zoom:Math.max(1,e)})})}onPlayerStateChange(t){this.sphereRotation=t.sphereRotation,this.viewpoint=t.viewpoint,this._updateRadarTransform(),this._updateRadarCrosshair(),this._updateCoordsDisplay(),this.ui.wrapper.classList.toggle("is-scripting",this.player.isPlayingScript)}onCameraMapLoaded(t){this.cameraMap=t,this._drawRadarPoints()}onActiveCameraChange(t){this.container.querySelectorAll(".radar-point").forEach(t=>t.classList.remove("is-active"));const e=this.container.querySelector(`#radar-point-${t}`);e&&e.classList.add("is-active")}_rotatePoint(t,e,i,s,a){const r=Math.cos(s),n=Math.sin(s),o=Math.cos(a),h=Math.sin(a),c=e*n+i*r;return{x:t*o+c*h,y:e*r-i*n,z:-t*h+c*o}}_project(t){const e=400/(t.z+400+this.R);return{x:t.x*e,y:t.y*e}}_updateRadarTransform(){const t=this.sphereRotation.x*Math.PI/180,e=this.sphereRotation.y*Math.PI/180,i=this.R;this.svgGrid.lines.forEach(({line:s,p1:a,p2:r})=>{const n=this._rotatePoint(a.x,a.y,a.z,t,e),o=this._rotatePoint(r.x,r.y,r.z,t,e);if(n.z>.9*-this.R&&o.z>.9*-this.R){const t=this._project(n),e=this._project(o);s.setAttribute("x1",t.x+i),s.setAttribute("y1",t.y+i),s.setAttribute("x2",e.x+i),s.setAttribute("y2",e.y+i),s.style.display="block"}else s.style.display="none"}),this.cameraPoints&&Object.values(this.cameraPoints).forEach(s=>{const a=this._rotatePoint(s.p3d.x,s.p3d.y,s.p3d.z,t,e);if(a.z>.5*-this.R){const t=this._project(a);s.element.style.transform=`translate(${t.x+i}px, ${t.y+i}px)`,s.element.style.opacity="1",s.element.style.zIndex=Math.round(a.z)}else s.element.style.opacity="0"})}_drawRadarPoints(){this.cameraMap&&(this.cameraPoints={},this.ui.sphereContainer.querySelectorAll(".radar-point").forEach(t=>t.remove()),this.cameraMap.layout.forEach(t=>{const e=document.createElement("div");e.className="radar-point",e.id=`radar-point-${t.id}`,this.ui.sphereContainer.appendChild(e);const[i,s]=t.pos,a=i*Math.PI/180,r=-s*Math.PI/180;this.cameraPoints[t.id]={element:e,p3d:{x:this.R*Math.cos(r)*Math.sin(a),y:this.R*Math.sin(r),z:this.R*Math.cos(r)*Math.cos(a)}}}),this._updateRadarTransform())}_updateRadarCrosshair(){const t=1+.5*(this.viewpoint.zoom-1);this.ui.crosshair.style.transform=`scale(${t})`}_updateCoordsDisplay(){const t=-this.sphereRotation.x.toFixed(1),e=-this.sphereRotation.y.toFixed(1)%360,i=this.viewpoint.zoom.toFixed(2),s=this.viewpoint.height.toFixed(2);this.ui.coordsDisplay&&(this.ui.coordsDisplay.innerHTML=`\n              Az:${e}¬∞ El:${t}¬∞<br>\n              Zoom:${i} Height:${s}\n          `)}}window.FvvRadarPlugins=window.FvvRadarPlugins||{},window.FvvRadarPlugins.Sphere=FvvRadarSpherePlugin;class FvvPlayer extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(template.content.cloneNode(!0)),this.videoElements={},this.videoTextures={},this.isPlaying=!1,this.sphereRotation={x:-20,y:0},this.viewpoint={zoom:1,height:0},this.activeCameraId=null,this.isSwitching=!1,this.isCanvasSized=!1,this.isRecording=!1,this.isPlayingScript=!1,this.filmscript={keyframes:[]},this.currentRecordingKeyframe=null,this.lastRecordTime={rotation:0,view:0},this.playbackIndices={keyframe:0,rotation:0,view:0},this.pairingProvider=null,this.radarPlugin=null,this.isAudioEnabled=!1}connectedCallback(){this.canvas=this.shadowRoot.querySelector("canvas"),this.ui={audioBtn:this.shadowRoot.querySelector("#audio-onoff-btn"),playBtn:this.shadowRoot.querySelector("#play-pause-btn"),timeline:this.shadowRoot.querySelector("#timeline"),remoteBtn:this.shadowRoot.querySelector("#remote-btn"),qrModal:this.shadowRoot.querySelector("#qr-modal"),qrCodeEl:this.shadowRoot.querySelector("#qrcode"),wsAddressEl:this.shadowRoot.querySelector("#ws-address"),recordBtn:this.shadowRoot.querySelector("#record-btn"),playScriptBtn:this.shadowRoot.querySelector("#play-script-btn"),saveScriptBtn:this.shadowRoot.querySelector("#save-script-btn"),loadScriptBtn:this.shadowRoot.querySelector("#load-script-btn"),modeDisplay:this.shadowRoot.querySelector("#mode-display"),cameraInfoDisplay:this.shadowRoot.querySelector("#camera-info-display"),fullscreenBtn:this.shadowRoot.querySelector("#fullscreen-btn")},this.ui.remoteBtn.disabled=!0,this.ui.playBtn.addEventListener("click",()=>this.togglePlay()),this.ui.timeline.addEventListener("input",t=>this.seek(t.target.value)),this.ui.audioBtn.addEventListener("click",()=>{this.isAudioEnabled=!this.isAudioEnabled,this.ui.audioBtn.textContent=this.isAudioEnabled?"üîä":"üîá";for(const t in this.videoElements)this.videoElements[t].muted=!this.isAudioEnabled;console.log(`Audio ${this.isAudioEnabled?"enabled":"disabled"}.`)}),this.ui.remoteBtn.addEventListener("click",()=>this.showQrModal()),this.ui.qrModal.addEventListener("click",t=>{t.target===this.ui.qrModal&&(this.ui.qrModal.style.display="none")}),this.ui.recordBtn.addEventListener("click",()=>this.toggleRecording()),this.ui.playScriptBtn.addEventListener("click",()=>this.toggleScriptPlayback()),this.ui.saveScriptBtn.addEventListener("click",()=>this.saveScript()),this.ui.loadScriptBtn.addEventListener("click",()=>this.loadScript()),this.ui.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this._onFullscreenChange()),this._loadRadarPlugin(),this._initializePairingProvider(),this._initWebGL()&&this._loadData().then(()=>{this._updateActiveState(),this._renderLoop(),this._updateUIState()})}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.requestFullscreen().catch(t=>{alert(`Failed to enable fullscreen mode: ${t.message}`)})}_onFullscreenChange(){document.fullscreenElement===this?(this.ui.fullscreenBtn.innerHTML="ü°∫",this.ui.fullscreenBtn.title="Exit Full Screen"):(this.ui.fullscreenBtn.innerHTML="‚õ∂",this.ui.fullscreenBtn.title="Full Screen")}_loadRadarPlugin(){const t=this.getAttribute("radar-plugin-src"),e=this.shadowRoot.querySelector("#radar-plugin-container");if(t){console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ —Ä–∞–¥–∞—Ä–∞ –∏–∑: ${t}`);const i=document.createElement("script");i.src=t,i.onload=()=>{window.FvvRadarPlugins&&window.FvvRadarPlugins.Sphere?(this.radarPlugin=new window.FvvRadarPlugins.Sphere(this,e),console.log("–í–Ω–µ—à–Ω–∏–π –ø–ª–∞–≥–∏–Ω —Ä–∞–¥–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.")):console.error("–í–Ω–µ—à–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª —Å–µ–±—è –≤ window.FvvRadarPlugins.Sphere")},this.shadowRoot.appendChild(i)}else console.log("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ —Ä–∞–¥–∞—Ä–∞."),this.radarPlugin=new FvvRadarSpherePlugin(this,e)}_initializePairingProvider(){const t=this.getAttribute("pairing-provider")||"websocket";console.log(`Initializing the provider: ${t}`),this.pairingProvider="firebase"===t?new FirebasePairingProvider(this):new WebSocketPairingProvider(this),this.pairingProvider.initialize()}handleRemoteControl(t){if(!this.isPlayingScript&&"control"===t.type){const e=2,i=.03;this.sphereRotation.y+=t.state.move.x*e,this.sphereRotation.x-=t.state.move.y*e,this.sphereRotation.x=Math.max(-90,Math.min(90,this.sphereRotation.x)),this.setSphereRotation(this.sphereRotation),this.viewpoint.zoom+=t.state.zoom.x*i,this.viewpoint.zoom=Math.max(1,this.viewpoint.zoom),this.viewpoint.height+=t.state.zoom.y*i,this.viewpoint.height=Math.max(-1,Math.min(1,this.viewpoint.height)),this.setViewpoint(this.viewpoint)}}setSphereRotation(t){this.sphereRotation=t,this._updateActiveState(),this.dispatchEvent(new CustomEvent("statechange",{detail:this.getCurrentState()}))}setViewpoint(t){this.viewpoint=t,this._updateActiveState(),this.dispatchEvent(new CustomEvent("statechange",{detail:this.getCurrentState()}))}getCurrentState(){return{isPlayingScript:this.isPlayingScript,sphereRotation:this.sphereRotation,viewpoint:this.viewpoint}}_updateUIState(){this.isPlayingScript?(this.ui.modeDisplay.textContent="MODE: SCRIPT",this.ui.playBtn.disabled=!0,this.ui.recordBtn.disabled=!0,this.ui.loadScriptBtn.disabled=!0,this.ui.saveScriptBtn.disabled=!0,this.ui.playScriptBtn.disabled=!1,this.ui.playScriptBtn.innerHTML="‚ùö‚ùö"):(this.ui.modeDisplay.textContent="MODE: MAIN",this.ui.playBtn.disabled=!1,this.ui.recordBtn.disabled=!1,this.ui.playScriptBtn.innerHTML="‚ñ∫",this.isPlaying?(this.ui.loadScriptBtn.disabled=!0,this.ui.playScriptBtn.disabled=!0):(this.ui.loadScriptBtn.disabled=this.isRecording,this.ui.playScriptBtn.disabled=this.isRecording||0===this.filmscript.keyframes.length),this.ui.saveScriptBtn.disabled=this.isRecording||0===this.filmscript.keyframes.length)}_updateCameraInfoDisplay(){if(!this.activeCameraId||!this.cameraMap)return;const t=this.cameraMap.layout.find(t=>t.id===this.activeCameraId);if(t){const[e,i,s]=t.pos;this.ui.cameraInfoDisplay.innerHTML=`${this.activeCameraId} [${e}, ${i}, ${s}]`}}togglePlay(t){if(!this.isPlayingScript||void 0!==t){this.isPlaying=void 0!==t?t:!this.isPlaying;for(const t in this.videoElements)this.isPlaying?this.videoElements[t].play():this.videoElements[t].pause();this.ui.playBtn.textContent=this.isPlaying?"‚è∏Ô∏è":"‚ñ∂Ô∏è",this._updateUIState()}}_updateActiveState(){if(this.isPlayingScript)return;const t=this._findBestCamera();t&&this._setActiveCamera(t.id),this.canvas.style.transform=`scale(${this.viewpoint.zoom})`,this.dispatchEvent(new CustomEvent("statechange",{detail:this.getCurrentState()})),this.recordSubState()}_setActiveCamera(t){if(!this.isSwitching&&t!==this.activeCameraId){const e=this.videoElements[this.activeCameraId||t],i=e?e.currentTime:0;this.isRecording&&this.currentRecordingKeyframe&&(this.currentRecordingKeyframe.endTime=i),this.isSwitching=!0,this.canvas.classList.add("is-switching"),setTimeout(()=>{if(this.activeCameraId=t,this.canvas.classList.remove("is-switching"),this.isSwitching=!1,this.dispatchEvent(new CustomEvent("activecamerachange",{detail:this.activeCameraId})),this._updateCameraInfoDisplay(),this.isRecording){const e={startTime:i,endTime:-1,camera:t,shiftPlay:`${t}.mp4#t=${i.toFixed(2)}`,state:{rotation:[{time:i,...this.sphereRotation}],view:[{time:i,...this.viewpoint}]}};this.filmscript.keyframes.push(e),this.currentRecordingKeyframe=e,this.lastRecordTime={rotation:0,view:0}}},100)}}_handleRadarDrag(t){if(!this.isDraggingRadar||this.isPlayingScript)return;const e=t.clientX-this.lastMousePos.x,i=t.clientY-this.lastMousePos.y;this.lastMousePos={x:t.clientX,y:t.clientY},t.shiftKey?(this.viewpoint.height-=.01*i,this.viewpoint.height=Math.max(-1,Math.min(1,this.viewpoint.height))):(this.sphereRotation.y+=.5*e,this.sphereRotation.x-=.5*i,this.sphereRotation.x=Math.max(-90,Math.min(90,this.sphereRotation.x)),this._updateRadarTransform()),this._updateActiveState()}_handleRadarWheel(t){if(this.isPlayingScript)return;t.preventDefault();this.viewpoint.zoom-=.05*Math.sign(t.deltaY),this.viewpoint.zoom=Math.max(1,this.viewpoint.zoom),this._updateActiveState()}_updateRadarTransform(){this.ui.radarSphere.style.transform=`rotateX(${this.sphereRotation.x}deg) rotateY(${this.sphereRotation.y}deg)`}_drawRadar(){if(!this.cameraMap)return;this.ui.radarSphere.innerHTML="";this.cameraMap.layout.forEach(t=>{const e=document.createElement("div");e.className="radar-point",e.id=`radar-point-${t.id}`;const[i,s]=t.pos;e.style.transform=`rotateY(${i}deg) rotateX(${-s}deg) translateZ(75px)`,this.ui.radarSphere.appendChild(e)}),this._updateRadarTransform()}_updateRadarActivePoint(){this.shadowRoot.querySelectorAll(".radar-point").forEach(t=>t.classList.remove("is-active"));const t=this.shadowRoot.querySelector(`#radar-point-${this.activeCameraId}`);t&&t.classList.add("is-active")}seek(t){if(!this.activeCameraId)return;const e=this.videoElements[this.activeCameraId];if(e&&e.duration){const i=e.duration*(t/100);for(const t of Object.values(this.videoElements))t.currentTime=i;this.isPlayingScript&&(this.playbackIndices={keyframe:0,rotation:0,view:0})}}updateTimeline(){if(!this.activeCameraId)return;const t=this.videoElements[this.activeCameraId];t&&t.duration&&(this.ui.timeline.value=t.currentTime/t.duration*100)}showQrModal(){this.pairingProvider&&(this.ui.qrModal.style.display="flex")}toggleRecording(){if(!this.isPlayingScript){if(this.isRecording=!this.isRecording,this.isRecording)this.filmscript={keyframes:[]},this.currentRecordingKeyframe=null,this.ui.recordBtn.classList.add("is-recording"),this.ui.recordBtn.innerHTML="‚ñ†",console.log("Recording has started.");else{if(this.currentRecordingKeyframe){const t=this.videoElements[this.activeCameraId];this.currentRecordingKeyframe.endTime=t.currentTime}this.ui.recordBtn.classList.remove("is-recording"),this.ui.recordBtn.innerHTML="‚óè",this.filmscript.keyframes.length>0&&(this.ui.saveScriptBtn.disabled=!1),console.log("Recording has stopped.")}this._updateUIState()}}recordSubState(){if(!this.isRecording||!this.currentRecordingKeyframe)return;const t=Date.now();if(t-this.lastRecordTime.rotation>500){const e=this.videoElements[this.activeCameraId];this.currentRecordingKeyframe.state.rotation.push({time:e.currentTime,...this.sphereRotation}),this.lastRecordTime.rotation=t}if(t-this.lastRecordTime.view>500){const e=this.videoElements[this.activeCameraId];this.currentRecordingKeyframe.state.view.push({time:e.currentTime,...this.viewpoint}),this.lastRecordTime.view=t}}toggleScriptPlayback(){this.isPlayingScript?this.stopScriptPlayback():this.playScript()}playScript(){if(0===this.filmscript.keyframes.length)return;this.isPlayingScript=!0,this.playbackIndices={keyframe:0,rotation:0,view:0},this.dispatchEvent(new CustomEvent("statechange",{detail:this.getCurrentState()}));const t=this.filmscript.keyframes[0].startTime;for(const e of Object.values(this.videoElements))e.currentTime=t;this.togglePlay(!0)}stopScriptPlayback(){this.isPlayingScript=!1,this.dispatchEvent(new CustomEvent("statechange",{detail:this.getCurrentState()})),this.togglePlay(!1)}updateViewFromScript(){if(!this.isPlayingScript||!this.activeCameraId)return;const t=this.videoElements[this.activeCameraId].currentTime,e=this.filmscript.keyframes;for(;this.playbackIndices.keyframe<e.length-1&&-1!==e[this.playbackIndices.keyframe].endTime&&e[this.playbackIndices.keyframe].endTime<=t;)this.playbackIndices.keyframe++,this.playbackIndices.rotation=0,this.playbackIndices.view=0;const i=e[this.playbackIndices.keyframe];if(!i||-1!==i.endTime&&t>i.endTime)return void this.stopScriptPlayback();this._setActiveCamera(i.camera);const s=(e,i,s)=>{for(;i<e.length-2&&e[i+1].time<=t;)i++;const a=e[i],r=e[i+1]||a,n=r.time-a.time>1e-6?Math.min(1,(t-a.time)/(r.time-a.time)):1,o=(t,e,i)=>t+(e-t)*i;return"rotation"===s?(this.sphereRotation.x=o(a.x,r.x,n),this.sphereRotation.y=o(a.y,r.y,n)):"view"===s&&(this.viewpoint.zoom=o(a.zoom,r.zoom,n),this.viewpoint.height=o(a.height,r.height,n)),i};this.playbackIndices.rotation=s(i.state.rotation,this.playbackIndices.rotation,"rotation"),this.playbackIndices.view=s(i.state.view,this.playbackIndices.view,"view"),this.setSphereRotation(this.sphereRotation),this.canvas.style.transform=`scale(${this.viewpoint.zoom})`}saveScript(){const t=JSON.stringify(this.filmscript,null,2),e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download="my_view_script.json",s.click(),URL.revokeObjectURL(i)}loadScript(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=t=>{const e=t.target.files[0],i=new FileReader;i.onload=t=>{try{const i=JSON.parse(t.target.result);i.keyframes&&Array.isArray(i.keyframes)?(this.filmscript=i,this.ui.playScriptBtn.disabled=!1,this.ui.saveScriptBtn.disabled=!1,console.log(`Scenario "${e.name}" loaded successfully.`)):alert("Invalid script file format.")}catch(t){alert("Error reading file.")}},i.readAsText(e)},t.click()}async _loadData(){const t=this.getAttribute("src"),e=this.getAttribute("camera-map");t&&e&&(this.manifest=await(await fetch(t)).json(),this.cameraMap=await(await fetch(e)).json(),this.dispatchEvent(new CustomEvent("cameramaploaded",{detail:this.cameraMap})),this._initVideoSources())}_initVideoSources(){const t=this.hasAttribute("simulation-mode");for(const e of this.manifest.tracks){const i=document.createElement("video");i.id=e.id,i.muted=!0,i.loop=!0,i.playsinline=!0,i.crossOrigin="anonymous",t?i.srcObject=this._createDummyVideoStream(e.id,e.id.slice(-1)):i.src=e.url,i.addEventListener("loadedmetadata",()=>{this.isCanvasSized||(this.canvas.width=i.videoWidth,this.canvas.height=i.videoHeight,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.isCanvasSized=!0)}),i.addEventListener("timeupdate",()=>this.updateTimeline()),this.videoElements[e.id]=i,this.shadowRoot.querySelector("#video-container").appendChild(i),this.videoTextures[e.id]=this._initTexture()}}_createDummyVideoStream(t,e){const i=document.createElement("canvas");i.width=320,i.height=180,i.className="dummy-source-canvas",this.shadowRoot.querySelector("#dummy-canvas-container").appendChild(i);const s=i.getContext("2d");let a=0;const r=()=>{s.fillStyle=`hsl(${80*e}, 50%, 20%)`,s.fillRect(0,0,i.width,i.height),s.fillStyle="#fff",s.font="24px monospace",s.textAlign="center",s.fillText(`–ö–∞–º–µ—Ä–∞ ${t}`,i.width/2,i.height/2-20),s.font="48px monospace",s.fillText(""+a++,i.width/2,i.height/2+30),requestAnimationFrame(r)};return r(),i.captureStream(30)}_findBestCamera(){const t=-this.sphereRotation.y,e=this.sphereRotation.x;return this.cameraMap.layout.map(i=>{const[s,a,r]=i.pos;let n=Math.abs(t-s);n>180&&(n=360-n);const o=Math.abs(e-a),h=Math.sqrt(n*n+o*o)+50*Math.abs(this.viewpoint.height-(r||0));return{id:i.id,score:h}}).sort((t,e)=>t.score-e.score)[0]}_initWebGL(){const t=this.canvas.getContext("webgl");if(!t)return alert("WebGL is not supported by your browser."),console.error("WebGL context could not be created."),!1;this.gl=t;const e=this._createShaderProgram("attribute vec4 aVertexPosition; attribute vec2 aTextureCoord; varying highp vec2 vTextureCoord; void main() { gl_Position = aVertexPosition; vTextureCoord = aTextureCoord; }","precision mediump float; varying highp vec2 vTextureCoord; uniform sampler2D uSampler; void main() { gl_FragColor = texture2D(uSampler, vTextureCoord); }");return!!e&&(this.shaderProgram=e,this.programInfo={attribLocations:{vertexPosition:t.getAttribLocation(e,"aVertexPosition"),textureCoord:t.getAttribLocation(e,"aTextureCoord")},uniformLocations:{uSampler:t.getUniformLocation(e,"uSampler")}},this.buffers=this._initBuffers(),!0)}_renderLoop(){if(this.isPlayingScript&&this.updateViewFromScript(),this.activeCameraId){const t=this.videoElements[this.activeCameraId],e=this.videoTextures[this.activeCameraId];if(t&&e){this._updateTexture(t,e);const i=this.gl;i.clearColor(0,0,0,1),i.clear(i.COLOR_BUFFER_BIT),i.useProgram(this.shaderProgram),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.programInfo.uniformLocations.uSampler,0),i.bindBuffer(i.ARRAY_BUFFER,this.buffers.position),i.vertexAttribPointer(this.programInfo.attribLocations.vertexPosition,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.programInfo.attribLocations.vertexPosition),i.bindBuffer(i.ARRAY_BUFFER,this.buffers.textureCoord),i.vertexAttribPointer(this.programInfo.attribLocations.textureCoord,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this.programInfo.attribLocations.textureCoord),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}requestAnimationFrame(()=>this._renderLoop())}_updateTexture(t,e){const i=this.gl;e&&t&&t.readyState>=t.HAVE_CURRENT_DATA&&(i.bindTexture(i.TEXTURE_2D,e),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t))}_initTexture(){const t=this.gl,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),e}_initBuffers(){const t=this.gl,e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW);const i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW),{position:e,textureCoord:i}}_createShaderProgram(t,e){const i=this.gl,s=(t,e)=>{const s=i.createShader(t);return i.shaderSource(s,e),i.compileShader(s),i.getShaderParameter(s,i.COMPILE_STATUS)?s:(console.error("Shader compile error: "+i.getShaderInfoLog(s)),i.deleteShader(s),null)},a=s(i.VERTEX_SHADER,t),r=s(i.FRAGMENT_SHADER,e);if(!a||!r)return null;const n=i.createProgram();return i.attachShader(n,a),i.attachShader(n,r),i.linkProgram(n),i.getProgramParameter(n,i.LINK_STATUS)?n:(console.error("Shader link error: "+i.getProgramInfoLog(n)),null)}}customElements.define("fvv-player",FvvPlayer);